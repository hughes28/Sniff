{"version":3,"sources":["routes/PostRouter.js"],"names":["PostRouter","path","router","googleMapsClient","googleMaps","createClient","key","process","env","GOOGLE_API_KEY","googleClient","createPost","bind","init","post","delete","deletePost","editPost","get","getUserPosts","getLoggedInUserPosts","getPost","markAsFound","req","res","postId","params","id","errorMsg","PostModels","postDb","findOne","where","deleted","include","model","AttributeModels","attributeDb","as","attributes","exclude","then","data","status","json","message","catch","err","username","UserModels","userDb","user_name","active","user","findAll","submitter_user_id","found","session","update","returns","error","onComplete","reverseGeocode","latlng","latitude","longitude","city","state","country","results","length","formattedAddress","formatted_address","components","split","trimmedComponents","map","component","trim","rawData","body","name","lastSeen","reward","contact","description","submitterUserId","db","transaction","t","console","log","create","last_seen","additionalAttributes","attr","post_id","bulkCreate","individualHooks","foundUserId","dataValues","found_user_id","returning","plain"],"mappings":"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","file":"PostRouter.js","sourcesContent":["// @ flow\n\n'use strict';\n\nimport { Router }  from 'express';\nimport UserModels from '../models/user';\nimport PostModels from '../models/post';\nimport AttributeModels from '../models/attribute';\nimport bcrypt from 'bcryptjs';\nimport db from '../models/Database';\nimport googleMaps from '@google/maps';\n\ntype CreatePostParams = {\n    name: string,\n    lastSeen: date,\n    reward: float,\n    longitude: double,\n    latitude: double,\n    contact: string,\n    description: string,\n    formattedAddress: string,\n    submitterUserId: number,\n};\n\nexport default class PostRouter {\n    // these fields must be type annotated, or Flow will complain!\n    router: Router;\n    path: string;\n    googleClient: Object;\n\n    // take the mount path as the constructor argument\n    constructor(path = '/api/v1/post') {\n        // instantiate the express.Router\n        this.router = Router();\n        const googleMapsClient = googleMaps.createClient({\n            key: process.env.GOOGLE_API_KEY,\n        });\n        this.googleClient = googleMapsClient;\n        this.path = path;\n        // glue it all together\n        this.createPost = this.createPost.bind(this);\n        this.init();\n    }\n\n    /**\n    * Attach route handlers to their endpoints.\n    */\n    init(): void {\n        this.router.post('/create', this.createPost);\n        this.router.delete('/delete/:id', this.deletePost);\n        this.router.post('/edit/:id', this.editPost);\n        this.router.get('/userposts/:username', this.getUserPosts);\n        this.router.get('/logged-in-userposts', this.getLoggedInUserPosts);\n        this.router.get('/get/:id', this.getPost);\n        this.router.post('/found/:id', this.markAsFound);\n    }\n\n    getPost(req: $Request, res: $Response): void {\n        const postId = req.params.id;\n        const errorMsg : string = 'Unable to find post.';\n\n        PostModels.postDb.findOne({\n            where: {\n                id: postId,\n                deleted: false,\n            },\n            include: [\n                {\n                    model: AttributeModels.attributeDb,\n                    as: 'additional_attributes',\n                    attributes: {exclude: ['id', 'post_id']},\n                },\n            ],\n        }).then((data) => {\n            if (!!data) {\n                return res.status(200).json({\n                    data\n                });\n            } else {\n                return res.status(404).json({\n                    message: 'Specified post does not exist.'\n                });\n            }\n        }).catch((err) => {\n            return res.status(401).json({message: errorMsg});\n        });\n    }\n\n    getUserPosts(req: $Request, res: $Response): void {\n        const username = req.params.username;\n        let errorMsg : string = 'Unable to find user.';\n\n        UserModels.userDb.findOne({\n            where: {\n                user_name: username,\n                active: true,\n            }\n        }).then((user) => {\n             if (!!user) {\n                errorMsg = 'Unable to find posts.';\n                PostModels.postDb.findAll({\n                    where: {\n                        submitter_user_id: user.id,\n                        deleted: false,\n                        found: false,\n                    },\n                    include: [\n                        {\n                            model: AttributeModels.attributeDb,\n                            as: 'additional_attributes',\n                            attributes: {exclude: ['id', 'post_id']},\n                        },\n                    ],\n                }).then((data) => {\n                    return res.status(200).json({\n                        data\n                    });\n                }).catch((err) => {\n                    return res.status(400).json({message: errorMsg});\n                });\n            } else {\n                return res.status(404).json({\n                    message: 'User does not exist.'\n                });\n            }\n        }).catch((err) => {\n            return res.status(401).json({message: errorMsg});\n        });\n\n    }\n\n    getLoggedInUserPosts(req: $Request, res: $Response): void {\n        const errorMsg : string = 'Unable to find posts.';\n\n        if (!!req.session.key) {\n            PostModels.postDb.findAll({\n                where: {\n                    submitter_user_id: req.session.key['id'],\n                    deleted: false,\n                    found: false,\n                },\n                include: [\n                    {\n                        model: AttributeModels.attributeDb,\n                        as: 'additional_attributes',\n                        attributes: {exclude: ['id', 'post_id']},\n                    },\n                ],\n            }).then((data) => {\n                return res.status(200).json({\n                    data\n                });\n            }).catch((err) => {\n                return res.status(400).json({message: errorMsg});\n            });\n        } else {\n            return res.status(401).json({\n                message: 'User not authenticated.'\n            })\n        }\n    }\n\n    deletePost(req: $Request, res: $Response): void {\n        const postId = req.params.id;\n        let errorMsg : string = 'Unable to delete post.';\n\n        if (!!req.session.key) {\n            PostModels.postDb.update({\n                deleted: true,\n            },{\n                where: {\n                    id: postId,\n                    submitter_user_id: req.session.key['id'],\n                },\n                returns: true,\n            }).then((data) => {\n                if (data[0] > 0) {\n                    return res.status(202).json({\n                        message: 'Successfully deleted post.',\n                    });\n                } else {\n                    return res.status(401).json({\n                        message: 'User not authenticated.'\n                    });\n                }\n            }).catch((err) => {\n                return res.status(400).json({\n                    message: errorMsg,\n                    error: err.message,\n                });\n            });\n        } else {\n            return res.status(401).json({\n                message: 'User not authenticated.'\n            })\n        }\n    }\n\n    reverseGeocode(post, onComplete) {\n        return this.googleClient.reverseGeocode({\n            latlng: [post.latitude, post.longitude],\n        }, (error, data) => {\n            post.city = 'Unknown';\n            post.state = 'Unknown';\n            post.country = 'Unknown';\n\n            if (error === null && data.json.results.length !== 0) {\n                const formattedAddress = data.json.results[0].formatted_address;\n\n                post.formattedAddress = formattedAddress;\n\n                const components = formattedAddress.split(',');\n                const trimmedComponents = components.map((component) => component.trim());\n                const length = trimmedComponents.length;\n\n                if (length >= 1) {\n                    post.country = trimmedComponents[length - 1];\n                }\n                if (length > 2) {\n                    if (length === 3) {\n                        post.city = trimmedComponents[length - 2];\n                    } else {\n                        post.state = trimmedComponents[length - 2];\n                        post.city = trimmedComponents[length - 3];\n                    }\n                }\n\n            } else {\n                const rawData = `Latitude (${post.latitude}), Longitude (${post.longitude})`;\n                post.formattedAddress = rawData;\n            }\n            onComplete(post);\n        });\n    }\n\n    createPost(req: $Request, res: $Response): void {\n        const { body } = req;\n        const params = {\n            name: body.name,\n            lastSeen: body.lastSeen,\n            reward: body.reward,\n            longitude: body.longitude,\n            latitude: body.latitude,\n            contact: body.contact,\n            description: body.description,\n            submitterUserId: req.session.key['id'],\n        };\n\n        if (params.longitude < -180 || params.longitude > 180 || params.latitude < -90 || params.latitude > 90) {\n            return res.status(400).json({\n                message: 'Invalid longitude-latitude combination.',\n            });\n        }\n\n        this.reverseGeocode(params, (post) => {\n            if (!!req.session.key) {\n                return db.transaction((t) => {\n                    console.log(' = Creating post');\n                    return PostModels.postDb.create({\n                        name: post.name,\n                        last_seen: post.lastSeen,\n                        reward: post.reward,\n                        longitude: post.longitude,\n                        latitude: post.latitude,\n                        contact: post.contact,\n                        city: post.city,\n                        state: post.state,\n                        country: post.country,\n                        description: post.description,\n                        formatted_address: post.formattedAddress,\n                        submitter_user_id: post.submitterUserId,\n                    }, {transaction: t}).then((data) => {\n                        console.log(' == Creating attributes');\n                        const additionalAttributes = body.additionalAttributes.map((attr) => {\n                            attr.post_id = data.id;\n                            return attr;\n                        });\n                        return AttributeModels.attributeDb.bulkCreate(additionalAttributes, {\n                            individualHooks: true,\n                            transaction: t,\n                        }).catch((err) => {\n                            console.log(\" == Bad attribute(s)\");\n                            console.log(err);\n                            throw err;\n                        })\n\n                    }).catch((err) => {\n                        console.log(\" = Bad post\");\n                        console.log(err);\n                        throw err;\n                    })\n\n                }).then((data) => {\n                    console.log(\"Committing\");\n                    return res.status(200).json({\n                        message: 'Post created.',\n                    });\n                }).catch((err) => {\n                    console.log(\"Rollback\");\n                    return res.status(500).json({\n                        message: 'Unable to create this post, please try again.',\n                        error: err,\n                    });\n                })\n\n            } else {\n                return res.status(401).json({\n                    message: 'User not authenticated.'\n                })\n            }\n        });\n    }\n\n    editPost(req: $Request, res: $Response): void {\n        const postId = req.params.id;\n        const { body } = req;\n\n        let errorMsg : string = 'Unable to edit post.';\n\n        if (body.longitude < -180 || body.longitude > 180 || body.latitude < -90 || body.latitude > 90) {\n            return res.status(400).json({\n                message: 'Invalid longitude-latitude combination.',\n            });\n        }\n\n        if (!!req.session.key) {\n            PostModels.postDb.update({\n                name: body.name,\n                last_seen: body.lastSeen,\n                reward: body.reward,\n                longitude: body.longitude,\n                latitude: body.latitude,\n                contact: body.contact,\n                description: body.description,\n                formatted_address: body.formattedAddress,\n            },{\n                where: {\n                    id: postId,\n                    submitter_user_id: req.session.key['id'],\n                },\n                returns: true,\n            }).then((data) => {\n                if (data[0] > 0) {\n                    return res.status(200).json({\n                        message: 'Successfully edited post.',\n                    });\n                } else {\n                    return res.status(401).json({\n                        message: 'User not authenticated.'\n                    });\n                }\n            }).catch((err) => {\n                return res.status(400).json({\n                    message: errorMsg,\n                    error: err.message,\n                });\n            });\n        } else {\n            return res.status(401).json({\n                message: 'User not authenticated.'\n            })\n        }\n\n    }\n\n    markAsFound(req: $Request, res: $Response): void {\n        const postId = req.params.id;\n        const { body } = req;\n        const username = body.username;\n\n        if (!!req.session.key) {\n            UserModels.userDb.findOne({\n                where: {\n                    user_name: username,\n                    active: true,\n                },\n            }).then((data) => {\n                let foundUserId = null;\n                if (!!data) {\n                    foundUserId = data.dataValues.id;\n                } else {\n                    return res.status(404).json({\n                        message: 'Username not found.',\n                    });\n                }\n                PostModels.postDb.update({\n                    found: true,\n                    found_user_id: foundUserId,\n                },{\n                    where: {\n                        id: postId,\n                        submitter_user_id: req.session.key['id'],\n                        found: false,\n                    },\n                    returning: true,\n                    plain: true,\n                }).then((data) => {\n                    console.log(data);\n                    if (!!data && !!data[1].dataValues) {\n                        return res.status(200).json({\n                            message: 'Successfully marked as found.',\n                        });\n                    } else {\n                        return res.status(500).json({\n                            message: 'Internal server error.'\n                        });\n                    }\n                }).catch((err) => {\n                    return res.status(400).json({\n                        message: 'User not authorized.',\n                        error: err.message,\n                    });\n                });\n            });\n        } else {\n            return res.status(401).json({\n                message: 'User not authenticated.'\n            });\n        }\n    }\n\n}\n"]}